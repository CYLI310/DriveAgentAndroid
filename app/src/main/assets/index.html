<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Taiwan Speed Trap Radar (Driving Mode)</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script type="module" src="https://unpkg.com/@material/web"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        /* ================================================= */
        /* 1. Global & Variables (Material 3)                */
        /* ================================================= */
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            box-sizing: border-box;
        }

        *, *::before, *::after {
            box-sizing: inherit;
        }

        /* DEFAULT: Dark Theme Variables (Material 3) */
        :root {
            --md-sys-color-primary: #D0BCFF;
            --md-sys-color-on-primary: #381E72;
            --md-sys-color-error: #F2B8B5;
            --md-sys-color-on-error: #601410;
            --md-sys-color-error-rgb: 242, 184, 181;
            --md-sys-color-background: #1C1B1F;
            --md-sys-color-on-background: #E6E0E9;
            --md-sys-color-surface: #1C1B1F;
            --md-sys-color-on-surface: #E6E0E9;
            --md-sys-color-surface-container-high: #36343B;
            --md-sys-color-surface-container-low: #28272C;
            --md-sys-color-on-surface-variant: #CAC4D0;
            --md-sys-color-outline: #938F99;
            --md-sys-color-red-sign: #B3261E;
        }

        /* LIGHT MODE OVERRIDE: Applied when body has the class (Material 3) */
        .light-mode-ui {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-error: #B3261E;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-error-rgb: 179, 38, 30;
            --md-sys-color-background: #FFFBFE;
            --md-sys-color-on-background: #1C1B1F;
            --md-sys-color-surface: #FFFBFE;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-surface-container-high: #E6E0EE;
            --md-sys-color-surface-container-low: #F7F2FA;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
        }

        body {
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            transition: background-color 0.3s;
        }

        /* ================================================= */
        /* 2. Layouts & Components                           */
        /* ================================================= */
        #map-container {
            position: relative;
            height: 100%;
            width: 100%;
            display: block;
        }

        /* Top Bar - Floating Block */
        #top-control-panel {
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 600px;
            width: calc(100% - 32px);
            border-radius: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);

            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background-color: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface);
            gap: 10px;
            transition: all 0.3s ease;
        }

        #mapid {
            height: 100%;
            width: 100%;
            z-index: 0;
        }

        /* FAB Container Styling - FLOATING CARD (Corrected to Middle Right) */
        .fab-container {
            position: fixed;
            top: 50%; /* Center vertically */
            transform: translateY(-50%); /* Adjust for vertical centering */
            right: 16px;

            display: flex;
            flex-direction: column;
            gap: 16px; /* INCREASED GAP */
            padding: 8px;
            background-color: var(--md-sys-color-surface-container-high);
            border-radius: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            z-index: 1001;
        }

        /* Driving Mode Overrides (omitted for brevity) */
        .driving-mode-active #map-container {
            display: flex;
            flex-direction: column;
        }
        .driving-mode-active #top-control-panel {
            position: static;
            height: 35vh;
            display: grid;
            transform: none;
            max-width: none;
            width: 100%;
            border-radius: 0;
            box-shadow: none;
            grid-template-columns: auto 1fr auto;
            grid-template-rows: auto 1fr;
            gap: 10px;
            padding: 16px;
        }
        .driving-mode-active #mapid { height: auto; flex-grow: 1; }

        /* Hide non-driving elements */
        .driving-mode-active #info-card,
        .driving-mode-active .fab-container,
        .driving-mode-active #driving-mode-button,
        .driving-mode-active #zoom-controls,
        .driving-mode-active #settings-button {
            display: none !important;
        }

        /* Driving Mode Specific Elements (omitted for brevity) */
        #exit-driving-mode-button { display: none; }
        .driving-mode-active #exit-driving-mode-button {
            display: block;
            grid-column: 1 / 2;
            grid-row: 1 / 2;
            align-self: flex-start;
        }
        .driving-mode-active #speed-dashboard {
            grid-column: 2 / 3;
            grid-row: 1 / 2;
            justify-content: center;
        }
        #driving-trap-alert {
            display: none;
            grid-column: 1 / 4;
            grid-row: 2 / 3;
            align-self: center;
            justify-self: center;
            margin: 0;
            padding: 16px 24px;
            border-radius: 28px;
            background-color: rgba(var(--md-sys-color-error-rgb), 0.95);
            color: var(--md-sys-color-on-error);
            text-align: center;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6);
            max-width: 90%;
            min-width: 200px;
        }
        #driving-trap-alert.visible {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Map Rotation (omitted for brevity) */
        .leaflet-map-pane, .leaflet-tile-pane, .leaflet-overlay-pane,
        .leaflet-marker-pane, .leaflet-shadow-pane {
            transition: transform 0.5s linear;
            transform-origin: 50% 50%;
        }

        /* Custom User Marker (omitted for brevity) */
        .custom-user-marker { display: flex; justify-content: center; align-items: center; width: 40px !important; height: 40px !important; border-radius: 50%; background-color: #4285F4; border: 4px solid #FFFFFF; box-shadow: 0 2px 6px rgba(0,0,0,0.6); z-index: 1000; }
        .custom-user-marker span { color: #FFFFFF; font-size: 28px !important; transition: transform 0.2s linear; }

        /* Traffic Overlay (omitted for brevity) */
        #traffic-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; background-color: var(--md-sys-color-surface-container-high); display: none; }
        #traffic-iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; z-index: 2000; }
        #close-traffic { position: absolute; top: 16px; left: 16px; z-index: 2001; --md-icon-button-icon-color: var(--md-sys-color-on-surface); --md-icon-button-container-color: rgba(255, 255, 255, 0.9); border-radius: 50%; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4); }

        /* Speed Dashboard (omitted for brevity) */
        #speed-dashboard {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        #speed-limit-sign {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: var(--md-sys-color-surface);
            border: 6px solid var(--md-sys-color-red-sign);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            color: var(--md-sys-color-on-surface);
            font-size: 1.8em;
            font-weight: 900;
        }
        #current-speed-container {
            padding: 8px 16px;
            border-radius: 28px;
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: baseline;
            gap: 8px;
            font-size: 3em;
            font-weight: 700;
            line-height: 1;
            transition: background-color 0.3s;
        }
        #current-speed-container.warning {
            background-color: var(--md-sys-color-error);
            color: var(--md-sys-color-on-error);
        }
        #current-speed-container #speed-unit {
            font-size: 0.3em;
            font-weight: 500;
            opacity: 1;
            align-self: flex-end;
            color: inherit;
            padding-bottom: 5px;
        }

        /* INFO CARD STYLES - CENTERED AND NARROWER */
        #info-card {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) translateY(0);
            max-width: 600px;
            width: calc(100% - 32px);
            max-height: 40%;
            margin: 0;
            padding: 0;
            background-color: var(--md-sys-color-surface-container-high);
            border-radius: 28px 28px 0 0;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.4);
            z-index: 1002;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out;
        }

        #info-card.collapsed {
            transform: translateX(-50%) translateY(calc(100% - 48px));
        }

        /* Internal padding matches floating card edge (16px) */
        #info-card-header {
            padding: 16px 16px 8px 16px;
            text-align: center; cursor: pointer; border-radius: 28px 28px 0 0; background-color: var(--md-sys-color-surface-container-high); position: sticky; top: 0; z-index: 1003;
        }

        #drag-handle { height: 4px; width: 40px; background-color: var(--md-sys-color-on-surface-variant); opacity: 0.3; margin: 0 auto 8px auto; border-radius: 2px; }

        #trap-list-container {
            padding: 0 16px 16px 16px;
        }

        .trap-item { padding: 10px 0; border-bottom: 1px solid var(--md-sys-color-surface); display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .trap-item:last-child { border-bottom: none; }
        .trap-details { display: flex; align-items: center; gap: 12px; flex-grow: 1; overflow: hidden; }
        .trap-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 1.1em; }
        .distance { font-weight: 500; color: var(--md-sys-color-primary); flex-shrink: 0; }
        .list-speed-sign { width: 40px; height: 40px; border-radius: 50%; background-color: var(--md-sys-color-surface); border: 4px solid var(--md-sys-color-red-sign); display: flex; justify-content: center; align-items: center; flex-shrink: 0; color: var(--md-sys-color-on-surface); font-size: 1em; font-weight: 900; }

        /* ================================================= */
        /* 5. Settings Panel Styling (omitted for brevity)   */
        /* ================================================= */
        #settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 3000;
            background-color: var(--md-sys-color-surface);
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            display: flex;
            flex-direction: column;
            color: var(--md-sys-color-on-surface);
        }

        #settings-overlay.visible {
            transform: translateX(0);
        }

        #settings-header {
            display: flex;
            align-items: center;
            padding: 16px;
            background-color: var(--md-sys-color-surface-container-high);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #settings-header h3 {
            flex-grow: 1;
            margin: 0;
            text-align: center;
            padding-right: 48px;
            font-weight: 500;
        }

        #settings-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
            overflow-y: auto;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            padding: 16px;
            border-bottom: 1px solid var(--md-sys-color-surface-container-low);
            transition: background-color 0.15s ease-in-out;
        }

        .setting-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1em;
            font-weight: 400;
        }

        .setting-item-description {
            font-size: 0.85em;
            color: var(--md-sys-color-on-surface-variant);
            margin-top: 4px;
        }

        .setting-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        /* Radio button styling for themes */
        .theme-radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .theme-radio-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
        }

        /* Proximity Range Slider */
        #proximity-range-slider {
            width: 100%;
            accent-color: var(--md-sys-color-primary);
        }

        /* Simple Checkbox Styling */
        #global-dark-mode-switch {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--md-sys-color-primary);
        }

        /* ================================================= */
        /* 6. Splash Screen Styles (omitted for brevity)     */
        /* ================================================= */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--md-sys-color-background);
            z-index: 4000; /* Highest priority */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
            transition: opacity 0.5s ease-out;
        }

        #splash-screen.fade-out {
            opacity: 0;
        }

        #splash-logo {
            font-size: 4em;
            color: var(--md-sys-color-primary);
            animation: pulse 1.5s infinite alternate;
        }

        #splash-text {
            color: var(--md-sys-color-on-background);
            font-size: 1.5em;
            font-weight: 500;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.1); opacity: 1; }
        }

        /* ================================================= */
        /* 7. Custom Leaflet Popup Styling (Material 3)      */
        /* ================================================= */
        .leaflet-popup-content-wrapper {
            background: var(--md-sys-color-surface-container-high);
            color: var(--md-sys-color-on-surface);
            border-radius: 16px; /* Material 3 large radius */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            padding: 0; /* Remove Leaflet's default padding */
        }
        .leaflet-popup-content {
            margin: 0;
            padding: 16px;
            font-size: 0.95em;
            font-weight: 500;
            text-align: left;
        }
        .leaflet-popup-tip {
            /* Ensures the tip color matches the wrapper */
            background: var(--md-sys-color-surface-container-high);
            box-shadow: none;
        }

        /* Style the popup content elements */
        .popup-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 1.1em;
            font-weight: 700;
            color: var(--md-sys-color-on-surface); /* Main text color */
        }
        .popup-header .material-symbols-outlined {
            font-size: 24px;
            color: var(--md-sys-color-error); /* Use error color for alert icon */
        }
        .popup-speed-limit-container {
             margin-bottom: 8px;
             font-size: 1.1em;
        }
        .popup-speed-limit {
            font-weight: 900;
            font-size: 1.3em;
            color: var(--md-sys-color-primary); /* Highlight the limit value */
            margin-right: 5px;
        }
        .popup-description {
            color: var(--md-sys-color-on-surface-variant);
            line-height: 1.4;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
<div id="splash-screen">
    <span id="splash-logo" class="material-symbols-outlined">navigation</span>
    <div id="splash-text">Loading Radar Map...</div>
</div>

<div id="map-container">

    <div id="top-control-panel">

        <md-icon-button id="exit-driving-mode-button" aria-label="Exit Driving Mode">
            <span class="material-symbols-outlined">close</span>
        </md-icon-button>

        <md-icon-button id="driving-mode-button" aria-label="Toggle Driving Mode">
            <span class="material-symbols-outlined">drive_eta</span>
        </md-icon-button>

        <div id="speed-dashboard">
            <div id="speed-limit-sign">
                <span id="speed-limit-value">--</span>
            </div>

            <div id="current-speed-container">
                <span id="current-speed-value">--</span>
                <span id="speed-unit">km/h</span>
            </div>
        </div>

        <div style="display: flex; gap: 8px;" id="zoom-controls">
            <md-icon-button id="settings-button" aria-label="Settings">
                <span class="material-symbols-outlined">settings</span>
            </md-icon-button>
            <md-icon-button id="zoom-in-button" aria-label="Zoom In">
                <span class="material-symbols-outlined">add</span>
            </md-icon-button>
            <md-icon-button id="zoom-out-button" aria-label="Zoom Out">
                <span class="material-symbols-outlined">remove</span>
            </md-icon-button>
        </div>

        <div id="driving-trap-alert">
            <div class="alert-limit"><span id="alert-limit-value">--</span> km/h</div>
            <div class="alert-description" id="alert-trap-description">Speed Trap Ahead!</div>
        </div>

    </div>

    <div id="mapid"></div>

    <div id="traffic-overlay">
        <md-icon-button id="close-traffic" aria-label="Close Traffic View">
            <span class="material-symbols-outlined">close</span>
        </md-icon-button>
        <iframe id="traffic-iframe" loading="lazy" allowfullscreen
                src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d154467.4300300647!2d120.91696550000001!3d23.6300188!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x34689626359df3ad%3A0x6b2406be3364f91d!2sTaiwan!5e0!3m2!1sen!2s!4v1700000000000!5m2!1sen!2s&traffic=yes"
                allow="geolocation">
        </iframe>
    </div>

    <div id="settings-overlay">
        <div id="settings-header">
            <md-icon-button id="close-settings" aria-label="Close Settings">
                <span class="material-symbols-outlined">arrow_back</span>
            </md-icon-button>
            <h3>Settings</h3>
        </div>

        <ul id="settings-list">

            <li class="setting-item" style="cursor: default;">
                <div class="setting-item-header">
                    <span>Dark UI Mode</span>
                    <input type="checkbox" id="global-dark-mode-switch" aria-label="Toggle Dark UI Mode">
                </div>
                <div class="setting-item-description">
                    Switch the entire app interface between light and dark themes.
                </div>
            </li>

            <li class="setting-item">
                <div class="setting-item-header">
                    <span>Alert Proximity</span>
                    <span id="proximity-range-display">500 m</span>
                </div>
                <div class="setting-item-description">
                    Distance before a trap to trigger a warning.
                </div>
                <div class="setting-controls">
                    <input type="range" id="proximity-range-slider" min="0.1" max="2.0" step="0.1" value="0.5">
                </div>
            </li>

            <li class="setting-item">
                <div class="setting-item-header">
                    <span>Map Tile Theme</span>
                </div>
                <div class="setting-item-description">
                    Choose the visual style for the map tiles (separate from UI theme).
                </div>
                <div class="theme-radio-group">
                    <label>
                        <input type="radio" name="map-theme" id="theme-light" value="light"> Light
                    </label>
                    <label>
                        <input type="radio" name="map-theme" id="theme-dark" value="dark"> Dark
                    </label>
                </div>
            </li>

            <li class="setting-item">
                <div class="setting-item-header">
                    <span>Language / 語言</span>
                </div>
                <div class="setting-item-description">
                    Choose the application interface language.
                </div>
                <div class="setting-controls theme-radio-group">
                    <label>
                        <input type="radio" name="language-select" id="lang-en" value="en" checked> English
                    </label>
                    <label>
                        <input type="radio" name="language-select" id="lang-zh" value="zh"> 繁體中文
                    </label>
                </div>
            </li>

            <li class="setting-item">
                <div class="setting-item-header">
                    <span>About This App</span>
                </div>
                <div class="setting-item-description">
                    Version 1.3.0. Data from open sources.
                </div>
            </li>

        </ul>
    </div>
    <div id="info-card">
        <div id="info-card-header" onclick="toggleCard()">
            <div id="drag-handle"></div>
            <h4 style="margin: 0; color: var(--md-sys-color-on-surface-variant);">Nearby Speed Traps (<span id="trap-count">0</span> Total)</h4>
        </div>
        <div id="trap-list-container">
            <p id="status-message" style="text-align: center; color: var(--md-sys-color-on-surface-variant); margin-top: 10px;">Locating you...</p>
            <ul id="trap-list" style="list-style: none; padding: 0; margin-top: 10px;">
            </ul>
        </div>
    </div>

    <div class="fab-container">

        <md-fab id="map-theme-toggle" class="child-fab" aria-label="Toggle Light/Dark Map">
            <span id="map-theme-icon" class="material-symbols-outlined">dark_mode</span>
        </md-fab>

        <md-fab id="traffic-fab" class="child-fab" aria-label="View Traffic">
            <span class="material-symbols-outlined">traffic</span>
        </md-fab>

        <md-fab id="recenter-and-rotate-fab" class="child-fab" aria-label="Recenter and Toggle Map Rotation">
            <span id="recenter-icon" class="material-symbols-outlined">my_location</span>
        </md-fab>
    </div>
</div>

<script>
    // --- NATIVE BRIDGE UTILITY FUNCTIONS (REPLACEMENT FOR COOKIES/LOCALSTORAGE) ---
    function saveSetting(name, value) {
        // Use the Kotlin bridge if available
        if (typeof AndroidSettingsBridge !== 'undefined') {
            AndroidSettingsBridge.saveSetting(name, value);
        } else {
            // Fallback for browser/testing environment (using localStorage as requested)
            localStorage.setItem(name, value);
        }
    }

    function getSetting(name) {
        if (typeof AndroidSettingsBridge !== 'undefined') {
            // Returns null if not found
            return AndroidSettingsBridge.getSetting(name);
        } else {
            // Fallback for browser/testing environment (using localStorage as requested)
            return localStorage.getItem(name);
        }
    }

    // --- CONSTANTS ---
    const initialCoords = [23.6, 120.9];
    let PROXIMITY_RANGE_KM = 0.5; // Default 500 meters
    const DEFAULT_ZOOM = 14;
    const DRIVING_MODE_ZOOM = 17;
    const INFO_CARD_UPDATE_THROTTLE_MS = 5000;

    // Map Tile URL Definitions
    const MAP_THEMES = {
        LIGHT: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
        DARK: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
    };

    // --- LANGUAGE DICTIONARY ---
    const DICT = {
        'en': {
            'appTitle': 'Taiwan Speed Trap Radar (Driving Mode)',
            'exitDrivingMode': 'Exit Driving Mode',
            'toggleDrivingMode': 'Toggle Driving Mode',
            'zoomIn': 'Zoom In',
            'zoomOut': 'Zoom Out',
            'settings': 'Settings',
            'speedUnit': 'km/h',
            'trapAlert': 'Speed Trap Ahead!',
            'trapAlertUnknown': 'Unknown Speed Trap Ahead!',
            'alertLimitUnit': 'km/h',
            'nearbyTrapsTitle': 'Nearby Speed Traps',
            'total': 'Total',
            'statusLocating': 'Locating you...',
            'statusTracking': 'Tracking live. Accuracy: ±{acc}m. Found {count} traps.',
            'statusNoTraps': 'No speed traps found within the search range.',
            'statusLoadError': 'Error: Failed to process GeoJSON. Starting location tracking...',
            'statusAndroidError': 'Error: Android bridge is unavailable. Starting location tracking without trap data.',
            'popupHeader': 'Fixed Speed Trap',
            'popupLimitUnit': 'km/h Limit',
            'popupLimitMissing': 'Limit not specified in data',
            'locationDetailsNotFound': 'Location details not explicitly found.',
            'uiDarkMode': 'Dark UI Mode',
            'uiDarkModeDesc': 'Switch the entire app interface between light and dark themes.',
            'alertProximity': 'Alert Proximity',
            'alertProximityDesc': 'Distance before a trap to trigger a warning.',
            'mapTileTheme': 'Map Tile Theme',
            'mapTileThemeDesc': 'Choose the visual style for the map tiles (separate from UI theme).',
            'aboutApp': 'About This App',
            'aboutAppDesc': 'Version 1.3.0. Data from open sources.',
            'locationDenied': '❌ **Geolocation Denied!** Please enable location services for this app in your device/browser settings.',
            'locationUnavailable': '⚠️ **Location Unavailable!** Your position could not be determined. Check GPS signal.',
            'locationTimeout': '⏳ **Location Timeout!** Took too long to get a fix. **Attempting restart...**',
        },
        'zh': {
            'appTitle': '台灣測速照相雷達 (駕駛模式)',
            'exitDrivingMode': '離開駕駛模式',
            'toggleDrivingMode': '切換駕駛模式',
            'zoomIn': '放大',
            'zoomOut': '縮小',
            'settings': '設定',
            'speedUnit': '公里/小時',
            'trapAlert': '前方有測速照相!',
            'trapAlertUnknown': '前方有測速照相 (限速未知)!',
            'alertLimitUnit': '公里/小時',
            'nearbyTrapsTitle': '附近測速照相',
            'total': '總數',
            'statusLocating': '定位中...',
            'statusTracking': '即時追蹤中。準確度：±{acc}米。已載入 {count} 個點位。',
            'statusNoTraps': '在搜索範圍內沒有發現測速照相。',
            'statusLoadError': '錯誤：GeoJSON 處理失敗。開始位置追蹤...',
            'statusAndroidError': '錯誤：Android 橋接器不可用。未載入照相點位，開始位置追蹤。',
            'popupHeader': '固定式測速照相',
            'popupLimitUnit': '公里/小時 限速',
            'popupLimitMissing': '數據中未指定限速',
            'locationDetailsNotFound': '未找到明確的位置詳細信息。',
            'uiDarkMode': '深色介面模式',
            'uiDarkModeDesc': '切換應用程式介面的亮色和深色主題。',
            'alertProximity': '警報距離',
            'alertProximityDesc': '觸發警告前與測速照相的距離。',
            'mapTileTheme': '地圖圖塊主題',
            'mapTileThemeDesc': '選擇地圖圖塊的視覺樣式（與介面主題分開）。',
            'aboutApp': '關於此應用程式',
            'aboutAppDesc': '版本 1.3.0。數據來源於開放資料。',
            'locationDenied': '❌ **定位功能被拒!** 請在設備/瀏覽器設置中啟用此應用的位置服務。',
            'locationUnavailable': '⚠️ **位置不可用!** 無法確定您的位置。請檢查GPS訊號。',
            'locationTimeout': '⏳ **定位超時!** 獲取位置花費時間過長。**嘗試重新啟動...**',
        }
    };


    // --- STATE AND MAP INITIALIZATION ---
    const map = L.map('mapid', { zoomControl: false }).setView(initialCoords, 8);
    let userMarker = null;
    let accuracyCircle = null;
    let geoJsonLayer = null;
    let currentTileLayer = null;
    let totalTrapCount = 0;

    // State Variables
    let isUIDarkMode = false;
    let isLightMode = true;
    let isDrivingMode = false;
    let isHeadingUpMode = false;
    let watchId = null;
    let rotationTarget;
    let lastInfoCardUpdate = 0;
    let isTrackingFrozen = false;
    let currentLanguage = 'en';

    // DOM elements
    const trafficOverlay = document.getElementById('traffic-overlay');
    const trafficFab = document.getElementById('traffic-fab');
    const recenterIcon = document.getElementById('recenter-and-rotate-fab');
    const closeTrafficButton = document.getElementById('close-traffic');
    const mapThemeIcon = document.getElementById('map-theme-toggle');
    const settingsOverlay = document.getElementById('settings-overlay');
    const proximitySlider = document.getElementById('proximity-range-slider');
    const proximityDisplay = document.getElementById('proximity-range-display');
    const themeRadios = document.querySelectorAll('input[name="map-theme"]');
    const globalDarkModeSwitch = document.getElementById('global-dark-mode-switch');
    const langRadios = document.querySelectorAll('input[name="language-select"]');


    // --- NEW TRANSLATION FUNCTION ---
    function translateUI() {
        const dict = DICT[currentLanguage];

        // 1. Core Labels
        document.title = dict.appTitle;
        document.getElementById('current-speed-value').nextElementSibling.textContent = dict.speedUnit;

        // 2. Info Card
        // The innerHTML update for the info card header is crucial for showing the translated title and 'Total' count
        document.querySelector('#info-card-header h4').innerHTML = `${dict.nearbyTrapsTitle} (<span id="trap-count">${totalTrapCount}</span> ${dict.total})`;

        // 3. Settings Panel
        document.querySelector('#settings-header h3').textContent = dict.settings;

        // UI Dark Mode
        document.querySelector('li:nth-child(1) .setting-item-header span:nth-child(1)').textContent = dict.uiDarkMode;
        document.querySelector('li:nth-child(1) .setting-item-description').textContent = dict.uiDarkModeDesc;

        // Alert Proximity
        const proximityHeader = document.querySelector('li:nth-child(2) .setting-item-header span:nth-child(1)');
        proximityHeader.textContent = dict.alertProximity;
        document.querySelector('li:nth-child(2) .setting-item-description').textContent = dict.alertProximityDesc;
        updateProximityDisplay(PROXIMITY_RANGE_KM); // Update display with correct unit

        // Map Tile Theme
        const mapThemeHeader = document.querySelector('li:nth-child(3) .setting-item-header span:nth-child(1)');
        mapThemeHeader.textContent = dict.mapTileTheme;
        document.querySelector('li:nth-child(3) .setting-item-description').textContent = dict.mapTileThemeDesc;
        document.getElementById('theme-light').nextSibling.textContent = currentLanguage === 'zh' ? '亮色' : 'Light';
        document.getElementById('theme-dark').nextSibling.textContent = currentLanguage === 'zh' ? '深色' : 'Dark';

        // Language Toggle
        const langItem = document.querySelector('li:nth-child(4)');
        langItem.querySelector('.setting-item-header span:nth-child(1)').textContent = currentLanguage === 'zh' ? '語言 / Language' : 'Language / 語言';
        langItem.querySelector('.setting-item-description').textContent = currentLanguage === 'zh' ? '選擇應用程式介面語言。' : 'Choose the application interface language.';

        // About App
        const aboutAppHeader = document.querySelector('li:nth-child(5) .setting-item-header span:nth-child(1)');
        aboutAppHeader.textContent = dict.aboutApp;
        document.querySelector('li:nth-child(5) .setting-item-description').textContent = dict.aboutAppDesc;

        // Set radio buttons correctly
        document.getElementById(`lang-${currentLanguage}`).checked = true;

        // Also update the UI components' aria-labels for accessibility
        document.getElementById('driving-mode-button').setAttribute('aria-label', dict.toggleDrivingMode);
        document.getElementById('exit-driving-mode-button').setAttribute('aria-label', dict.exitDrivingMode);
        document.getElementById('settings-button').setAttribute('aria-label', dict.settings);

        // Re-run the status message update to translate it
        const statusMsg = document.getElementById('status-message');
        if (statusMsg.textContent.includes('Tracking live') || statusMsg.textContent.includes('即時追蹤中')) {
             // We can't access `position` here reliably, so just show initial tracking message
             statusMsg.textContent = dict.statusTracking.replace('{acc}', '...').replace('{count}', totalTrapCount);
        } else if (statusMsg.textContent.includes('Locating') || statusMsg.textContent.includes('定位中')) {
            statusMsg.textContent = dict.statusLocating;
        }
    }


    // --- SETTINGS LOGIC ---
    function loadSettings() {
        const proximity = getSetting('proximityRange');
        const mapTheme = getSetting('mapTheme');
        const uiTheme = getSetting('uiTheme');
        const language = getSetting('language'); // <-- NEW

        // 1. UI Theme
        if (uiTheme === 'dark') {
            isUIDarkMode = true;
            document.body.classList.remove('light-mode-ui');
            globalDarkModeSwitch.checked = true;
        } else if (uiTheme === 'light') {
            isUIDarkMode = false;
            document.body.classList.add('light-mode-ui');
            globalDarkModeSwitch.checked = false;
        } else {
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            isUIDarkMode = prefersDark;
            globalDarkModeSwitch.checked = prefersDark;
            if (!prefersDark) {
                document.body.classList.add('light-mode-ui');
            }
        }

        // 2. Proximity
        if (proximity) {
            PROXIMITY_RANGE_KM = parseFloat(proximity);
            proximitySlider.value = PROXIMITY_RANGE_KM;
        }

        // 3. Map Theme
        if (mapTheme) {
            if (mapTheme === 'dark') {
                isLightMode = false;
                document.getElementById('theme-dark').checked = true;
            } else {
                isLightMode = true;
                document.getElementById('theme-light').checked = true;
            }
        } else {
             // Default to Light map theme
            document.getElementById('theme-light').checked = true;
        }

        // 4. Language
        if (language && DICT[language]) {
            currentLanguage = language;
        } else {
            // Default to English if not set
            currentLanguage = 'en';
        }

        // Apply all UI translations and updates
        translateUI();
        initializeMapTheme();
    }

    function saveSettings() {
        saveSetting('proximityRange', PROXIMITY_RANGE_KM.toFixed(1));
        saveSetting('mapTheme', isLightMode ? 'light' : 'dark');
        saveSetting('uiTheme', isUIDarkMode ? 'dark' : 'light');
        saveSetting('language', currentLanguage); // <-- NEW
    }

    function updateProximityDisplay(km) {
        proximityDisplay.textContent = km >= 1 ? `${km.toFixed(1)} km` : `${Math.round(km * 1000)} m`;
    }

    function toggleUIDarkMode() {
        isUIDarkMode = globalDarkModeSwitch.checked;

        if (isUIDarkMode) {
            document.body.classList.remove('light-mode-ui');
        } else {
            document.body.classList.add('light-mode-ui');
        }
        saveSettings();
    }


    // --- MAP THEME ---

    function initializeMapTheme() {
        if (currentTileLayer) {
            map.removeLayer(currentTileLayer);
        }

        const themeUrl = isLightMode ? MAP_THEMES.LIGHT : MAP_THEMES.DARK;
        currentTileLayer = L.tileLayer(themeUrl, {
            maxZoom: 19,
            attribution: '© CartoDB, © OpenStreetMap'
        }).addTo(map);
        mapThemeIcon.querySelector('span').textContent = isLightMode ? 'dark_mode' : 'light_mode';
    }

    function toggleMapTheme() {
        isLightMode = !isLightMode;
        if (currentTileLayer) {
            map.removeLayer(currentTileLayer);
        }

        const themeUrl = isLightMode ? MAP_THEMES.LIGHT : MAP_THEMES.DARK;
        currentTileLayer = L.tileLayer(themeUrl, {
            maxZoom: 19,
            attribution: '© CartoDB, © OpenStreetMap'
        }).addTo(map);

        mapThemeIcon.querySelector('span').textContent = isLightMode ? 'dark_mode' : 'light_mode';

        document.getElementById(isLightMode ? 'theme-light' : 'theme-dark').checked = true;
        saveSettings();
    }


    // --- ROTATION UTILITY ---

    function initializeRotationTarget() {
        const mapPane = map.getPane('mapPane');
        if (mapPane) {
            rotationTarget = mapPane;
        } else {
            console.error("Leaflet mapPane not found for rotation.");
        }
    }

    function rotateMap(heading) {
        if (!rotationTarget || heading === null) return;
        const rotationAngle = -heading;
        rotationTarget.style.transform = `rotate(${rotationAngle}deg)`;
    }

    // --- UI/UX CONTROL FUNCTIONS ---

    function zoomIn() { map.zoomIn(1); }
    function zoomOut() { map.zoomOut(1); }

    function showSettings() { settingsOverlay.classList.add('visible'); }
    function hideSettings() { settingsOverlay.classList.remove('visible'); }

    function toggleDrivingMode() {
        isDrivingMode = !isDrivingMode;
        const body = document.body;
        const mapContainer = document.getElementById('map-container');

        if (isDrivingMode) {
            body.classList.add('driving-mode-active');
            mapContainer.classList.add('driving-mode-active');
            isHeadingUpMode = true;
            isTrackingFrozen = false;
            recenterIcon.querySelector('span').textContent = 'navigation';
            trafficOverlay.style.display = 'none';

            map.dragging.disable();
            map.touchZoom.disable();
            map.doubleClickZoom.disable();
            map.scrollWheelZoom.disable();

            if (userMarker) {
                 map.setView(userMarker.getLatLng(), DRIVING_MODE_ZOOM, { animate: true, duration: 0.5 });
            }
        } else {
            body.classList.remove('driving-mode-active');
            mapContainer.classList.remove('driving-mode-active');
            isHeadingUpMode = false;
            isTrackingFrozen = false;
            recenterIcon.querySelector('span').textContent = 'my_location';

            if (rotationTarget) { rotationTarget.style.transform = ''; }
            const iconSpan = userMarker ? userMarker._icon.querySelector('span') : null;
            if (iconSpan) { iconSpan.style.transform = ''; }

            document.getElementById('driving-trap-alert').classList.remove('visible');

            map.dragging.enable();
            map.touchZoom.enable();
            map.doubleClickZoom.enable();
            map.scrollWheelZoom.enable();

            const center = userMarker ? userMarker.getLatLng() : map.getCenter();
            map.setView(center, DEFAULT_ZOOM, { animate: true, duration: 0.5 });
        }

        setTimeout(() => {
            map.invalidateSize();
            if (userMarker) {
                map.panTo(userMarker.getLatLng(), { animate: false });
            }
        }, 350);
    }

    // --- GEOJSON LOADING FUNCTION ---
    function loadGeojsonData() {
        const statusMsg = document.getElementById('status-message');
        let finalStatus = DICT[currentLanguage].statusLocating;

        try {
            if (typeof Android !== 'undefined' && Android.getGeoJsonData) {
                const geoJsonString = Android.getGeoJsonData();

                if (geoJsonString) {
                    const data = JSON.parse(geoJsonString);

                    if (geoJsonLayer) { map.removeLayer(geoJsonLayer); }

                    geoJsonLayer = L.geoJSON(data, {
                        pointToLayer: function (feature, latlng) {
                            return L.circleMarker(latlng, {
                                radius: 8,
                                color: '#F2B8B5',
                                fillColor: '#B3261E',
                                fillOpacity: 0.8
                            });
                        },
                        // *** MODIFIED POPUP GENERATION FOR ROBUSTNESS AND TRANSLATION ***
                        onEachFeature: function (feature, layer) {
                            if (feature.properties) {
                                const limit = feature.properties.name;
                                const description = feature.properties.description || 'No details available.';

                                // Extract the address, typically contained in the description field
                                const addressMatch = description.match(/設置地址:\s*([^<]*)/);
                                const address = addressMatch && addressMatch[1] ? addressMatch[1].trim() : DICT[currentLanguage].locationDetailsNotFound;

                                // Conditional speed limit display based on data presence
                                const speedLimitHtml = limit
                                    ? `<span class="popup-speed-limit">${limit}</span> <span style="font-size: 1em;">${DICT[currentLanguage].popupLimitUnit}</span>`
                                    : `<span class="popup-description" style="color: var(--md-sys-color-error);">${DICT[currentLanguage].popupLimitMissing}</span>`;

                                const popupContent = `
                                    <div class="popup-header">
                                        <span class="material-symbols-outlined">camera_indoor</span>
                                        ${DICT[currentLanguage].popupHeader}
                                    </div>
                                    <div class="popup-speed-limit-container">
                                        ${speedLimitHtml}
                                    </div>
                                    <div class="popup-description">
                                        ${address}
                                    </div>
                                `;

                                layer.bindPopup(popupContent, {
                                    className: 'custom-popup',
                                    offset: L.point(0, -10)
                                });
                            }
                        }
                    }).addTo(map);

                    totalTrapCount = data.features.length;
                    document.getElementById('trap-count').textContent = totalTrapCount;

                    finalStatus = DICT[currentLanguage].statusTracking.replace('{acc}', '...').replace('{count}', totalTrapCount); // Initial tracking message
                } else {
                    finalStatus = DICT[currentLanguage].statusAndroidError;
                }
            } else {
                 finalStatus = DICT[currentLanguage].statusAndroidError;
            }
        } catch (e) {
            finalStatus = DICT[currentLanguage].statusLoadError;
            console.error("JSON/Load Error:", e);
        }

        statusMsg.textContent = finalStatus;
        startTracking();
    }

    // --- CONTINUOUS GEOLOCATION TRACKING ---
    function startTracking() {
        if (!("geolocation" in navigator)) {
            document.getElementById('status-message').textContent = "Error: Geolocation not supported.";
            return;
        }

        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }

        const options = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 5000
        };

        let position; // Declare position in the outer scope for the info card update

        watchId = navigator.geolocation.watchPosition(
            (currentPosition) => {
                position = currentPosition; // Store the latest position
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                const userCoords = [userLat, userLng];
                const heading = position.coords.heading;
                const accuracy = position.coords.accuracy;
                const isFollowingMode = isDrivingMode || isHeadingUpMode;

                const speedKmh = position.coords.speed !== null && position.coords.speed >= 0
                    ? position.coords.speed * 3.6
                    : 0;
                const roundedSpeedKmh = Math.round(speedKmh);
                document.getElementById('current-speed-value').textContent = roundedSpeedKmh;

                if (userMarker) {
                    userMarker.setLatLng(userCoords);
                    accuracyCircle.setLatLng(userCoords).setRadius(accuracy);
                } else {
                    userMarker = L.marker(userCoords, {
                        icon: L.divIcon({ className: 'custom-user-marker', iconSize: [40, 40], iconAnchor: [20, 20], html: '<span class="material-symbols-outlined">navigation</span>' })
                    }).addTo(map).bindPopup(DICT[currentLanguage].statusLocating); // Use translated text here

                    accuracyCircle = L.circle(userCoords, accuracy, {
                        weight: 1, fillColor: '#4285F4', fillOpacity: 0.1, color: '#4285F4', opacity: 0.5
                    }).addTo(map);

                    map.setView(userCoords, DEFAULT_ZOOM, { animate: true, duration: 0.5 });
                }

                const iconSpan = userMarker ? userMarker._icon.querySelector('span') : null;

                if (isFollowingMode) {
                    if (heading !== null && heading >= 0) {
                        rotateMap(heading);
                        if (iconSpan) { iconSpan.style.transform = `rotate(${heading}deg)`; }
                    } else {
                        rotateMap(0);
                        if (iconSpan) { iconSpan.style.transform = ''; }
                    }

                    if (!isTrackingFrozen) {
                        map.panTo(userCoords, { animate: true, duration: 0.5, easeLinearity: 0.1 });
                    }
                } else {
                    if (rotationTarget) { rotationTarget.style.transform = ''; }
                    if (iconSpan && heading !== null && heading >= 0) { iconSpan.style.transform = `rotate(${heading}deg)`;
                    } else if (iconSpan) { iconSpan.style.transform = ''; }

                    if (isTrackingFrozen) {
                         recenterIcon.querySelector('span').textContent = 'location_disabled';
                    }
                }
                userMarker.update();

                let nearestLimit = null;
                let nearestTrapName = null;
                let nearbyTraps = [];

                if (geoJsonLayer) {
                    geoJsonLayer.eachLayer(function(layer) {
                        const latlng = layer.getLatLng();
                        const distanceKm = calculateHaversineDistance(userLat, userLng, latlng.lat, latlng.lng);
                        const speedLimitValue = layer.feature.properties.name
                            ? parseFloat(layer.feature.properties.name)
                            : null;

                        // Retrieve the name/address for display in both alert and list
                        const description = layer.feature.properties.description || '';
                        const addressMatch = description.match(/設置地址:\s*([^<]*)/);
                        // **FIX: Use the extracted address for the name/description**
                        const trapDisplayName = addressMatch && addressMatch[1] ? addressMatch[1].trim() : DICT[currentLanguage].popupHeader;

                        // Only consider traps within proximity range for the main alert
                        if (distanceKm <= PROXIMITY_RANGE_KM) {
                            if (nearestTrapName === null || distanceKm < PROXIMITY_RANGE_KM) {

                                // Set nearestLimit based on existence
                                nearestLimit = speedLimitValue !== null ? Math.round(speedLimitValue) : null;

                                // Set alert name, defaulting to generic translated alert if data is sparse
                                nearestTrapName = trapDisplayName;

                                if (nearestLimit === null) {
                                    // Use a more descriptive alert if the limit is missing
                                    nearestTrapName = DICT[currentLanguage].trapAlertUnknown;
                                }
                            }
                        }

                        // Add all nearby traps (including those with null speed limit) for the info card list
                        if (distanceKm <= 5) {
                            // **FIX: Pass the correctly extracted name to the nearbyTraps array**
                            nearbyTraps.push({ name: trapDisplayName, distance: distanceKm, speedLimit: speedLimitValue });
                        }
                    });
                }

                const speedLimitSign = document.getElementById('speed-limit-value');
                const speedContainer = document.getElementById('current-speed-container');

                // Refined display for the top speed limit sign
                speedLimitSign.textContent = nearestLimit !== null ? nearestLimit : '--';
                speedContainer.classList.remove('warning');

                if (nearestLimit !== null && roundedSpeedKmh > nearestLimit) {
                    speedContainer.classList.add('warning');
                }

                const drivingAlert = document.getElementById('driving-trap-alert');

                // Refined driving alert logic
                if (isDrivingMode && nearestTrapName) {
                    drivingAlert.classList.add('visible');

                    // Show '--' if limit is null, otherwise show the limit
                    document.getElementById('alert-limit-value').textContent = nearestLimit !== null ? nearestLimit : '--';

                    document.getElementById('alert-trap-description').textContent = nearestTrapName;
                } else {
                    drivingAlert.classList.remove('visible');
                }

                // Info Card Update (Throttled)
                if (!isDrivingMode && (Date.now() - lastInfoCardUpdate > INFO_CARD_UPDATE_THROTTLE_MS)) {
                    lastInfoCardUpdate = Date.now();

                    const trapList = document.getElementById('trap-list');
                    trapList.innerHTML = '';
                    nearbyTraps.sort((a, b) => a.distance - b.distance);

                    const nearbyStatus = document.getElementById('status-message');
                    const filteredTraps = nearbyTraps.filter(t => t.distance <= 5);

                    if (filteredTraps.length > 0) {
                        nearbyStatus.style.display = 'none';
                    } else {
                        nearbyStatus.style.display = 'block';
                        nearbyStatus.textContent = DICT[currentLanguage].statusNoTraps;
                    }

                    filteredTraps.slice(0, 10).forEach(trap => {
                        const listItem = document.createElement('li');
                        const roundedLimit = trap.speedLimit !== null ? Math.round(trap.speedLimit) : '--';
                        listItem.className = 'trap-item';
                        // **FIXED: trap.name now holds the correct location/address**
                        listItem.innerHTML = `
                            <div class="trap-details">
                                <div class="list-speed-sign">${roundedLimit}</div>
                                <div class="trap-name">${trap.name}</div>
                            </div>
                            <div class="distance">${trap.distance.toFixed(2)} km</div>
                        `;
                        trapList.appendChild(listItem);
                    });
                }

                if (!isDrivingMode) {
                   const acc = Math.round(accuracy);
                   document.getElementById('status-message').textContent = DICT[currentLanguage].statusTracking.replace('{acc}', acc).replace('{count}', totalTrapCount);
                }

            },
            (error) => {
                const statusMsg = document.getElementById('status-message');
                console.error("Geolocation Watch Error:", error.message, `(Code: ${error.code})`);

                let userFriendlyMessage;

                if (error.code === 1) {
                    userFriendlyMessage = DICT[currentLanguage].locationDenied;
                } else if (error.code === 2) {
                    userFriendlyMessage = DICT[currentLanguage].locationUnavailable;
                } else if (error.code === 3) {
                    userFriendlyMessage = DICT[currentLanguage].locationTimeout;
                    if (watchId) {
                        navigator.geolocation.clearWatch(watchId);
                        watchId = null;
                        setTimeout(startTracking, 2000);
                    }
                } else {
                    userFriendlyMessage = DICT[currentLanguage].locationUnavailable;
                }

                statusMsg.innerHTML = userFriendlyMessage;
                document.getElementById('current-speed-value').textContent = '--';
                document.getElementById('speed-limit-value').textContent = '--';
                document.getElementById('current-speed-container').classList.remove('warning');
            },
            options
        );
    }

    // --- Utility Functions ---
    function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * (Math.PI / 180);
        const dLon = (lon2 - lon1) * (Math.PI / 180);

        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // --- UI Handlers ---
    const infoCard = document.getElementById('info-card');
    function toggleCard() { infoCard.classList.toggle('collapsed'); }

    // Event Listeners
    document.getElementById('exit-driving-mode-button').addEventListener('click', toggleDrivingMode);
    document.getElementById('driving-mode-button').addEventListener('click', toggleDrivingMode);
    document.getElementById('zoom-in-button').addEventListener('click', zoomIn);
    document.getElementById('zoom-out-button').addEventListener('click', zoomOut);

    document.getElementById('map-theme-toggle').addEventListener('click', toggleMapTheme);

    // Settings Button Handlers
    document.getElementById('settings-button').addEventListener('click', showSettings);
    document.getElementById('close-settings').addEventListener('click', hideSettings);

    // Global Dark Mode Checkbox Handler
    globalDarkModeSwitch.addEventListener('change', toggleUIDarkMode);

    // Proximity Slider Logic
    proximitySlider.addEventListener('input', (e) => {
        PROXIMITY_RANGE_KM = parseFloat(e.target.value);
        updateProximityDisplay(PROXIMITY_RANGE_KM);
    });
    proximitySlider.addEventListener('change', saveSettings);

    // **FIX: Explicitly call translateUI() to update all non-map-related text.**
    // Language Radio Logic
    langRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            currentLanguage = e.target.value;
            // 1. Update all static UI elements (Settings, Titles, Button labels)
            translateUI();
            // 2. Reload map data/popups and restart tracking (which updates dynamic status messages)
            loadGeojsonData();
            // 3. Save the new setting
            saveSettings();
        });
    });

    // Map Theme Radio Logic
    themeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            const newTheme = e.target.value;
            const newIsLightMode = (newTheme === 'light');
            if (newIsLightMode !== isLightMode) {
                toggleMapTheme();
            }
        });
    });


    // Recenter and Rotation Toggle Logic
    recenterIcon.addEventListener('click', () => {
        if (!userMarker) {
            map.setView(map.getCenter(), map.getZoom());
            return;
        }

        isTrackingFrozen = false;

        if (!isDrivingMode) {
            isHeadingUpMode = !isHeadingUpMode;
        }

        const iconSpan = userMarker ? userMarker._icon.querySelector('span') : null;

        if (isHeadingUpMode) {
            recenterIcon.querySelector('span').textContent = 'navigation';
        } else {
            recenterIcon.querySelector('span').textContent = 'my_location';

            if (rotationTarget) { rotationTarget.style.transform = ''; }
            if (iconSpan) { iconSpan.style.transform = ''; }
        }

        map.setView(userMarker.getLatLng(), map.getZoom(), { animate: true, duration: 0.5 });
    });

    // Leaflet Drag Listener to Freeze Tracking
    map.on('dragstart', () => {
        if (!isDrivingMode) {
            isTrackingFrozen = true;
            recenterIcon.querySelector('span').textContent = 'location_disabled';
        }
    });


    // Traffic Overlay Logic
    function closeTrafficView() {
        trafficOverlay.style.display = 'none';
        if (!isDrivingMode) { trafficFab.style.display = 'block'; }
    }

    trafficFab.addEventListener('click', () => { trafficOverlay.style.display = 'block'; trafficFab.style.display = 'none'; });

    closeTrafficButton.addEventListener('click', (e) => { e.stopPropagation(); closeTrafficView(); });

    trafficOverlay.addEventListener('click', (e) => {
        if (e.target.id === 'traffic-overlay') { closeTrafficView(); }
    });


    // --- INITIAL STARTUP ---
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Load User Preferences (and initialize language/theme by calling translateUI())
        loadSettings();

        // 2. Initialize Map Structure
        initializeRotationTarget();

        // 3. Load Trap Data (and starts tracking)
        loadGeojsonData();

        // 4. Splash Screen Logic
        const splashScreen = document.getElementById('splash-screen');
        setTimeout(() => {
            splashScreen.classList.add('fade-out');

            splashScreen.addEventListener('transitionend', () => {
                splashScreen.remove();
                map.invalidateSize();
            }, { once: true });

        }, 1500);
    });

    // --- ANDROID NATIVE COMMUNICATION (For backward compatibility) ---
    function triggerLocationUpdate() {
        console.warn("Native Android location trigger called, but continuous tracking is active via watchPosition().");
    }
</script>
</body>
</html>